---
import type { Props } from "@astrojs/starlight/props";
import Default from "starlight-plugin-icons/components/starlight/Sidebar.astro";
import { Kbd } from "starlight-kbd/components";

const { sidebar } = Astro.locals.starlightRoute;

//
// recursively find "Contents" links and inject the icon attribute
// this allows autogenerated indexes to have icons without manual config
function injectIcons(items: any[]): any[] {
  return items.map((item) => {
    if (item.type === "group") {
      return { ...item, entries: injectIcons(item.entries) };
    }
    if (item.type === "link" && item.label === "Contents") {
      return {
        ...item,
        attrs: {
          ...item.attrs,
          "data-icon": "i-material-symbols:format-list-bulleted",
        },
      };
    }
    return item;
  });
}

//
// apply mutation to the sidebar data
Astro.locals.starlightRoute.sidebar = injectIcons(sidebar);
---

<div class="sidebar-container">
  <div class="sidebar-search-wrapper">
    <input
      type="text"
      id="sidebar-input"
      placeholder="Search..."
      aria-label="Filter sidebar"
      autocomplete="off"
    />
    <div class="kbd-hint">
      <Kbd mac="/" windows="/" />
    </div>
  </div>
  <div id="sidebar-count" class="sidebar-count"></div>
</div>

<Default {...Astro.props}><slot /></Default>

<style>
  .sidebar-container {
    padding: 1rem var(--sl-sidebar-item-padding-inline) 0.25rem;
    /* currently flex, want to make it sticky without bugging */
    /* will tp instantly to search bar either way if / is pressed */
    position: flex;
    top: 0;
    z-index: 20;
    background-color: var(--sl-color-bg-sidebar);
  }

  .sidebar-search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  #sidebar-input {
    width: 100%;
    padding: 0.4rem 0.6rem;
    padding-right: 2rem;
    border-radius: 0.3rem;
    border: 1px solid var(--sl-color-gray-5);
    background: var(--sl-color-black);
    color: var(--sl-color-white);
    font-size: var(--sl-text-xs);
    outline: none;
  }

  #sidebar-input:focus {
    border-color: var(--sl-color-accent-high);
  }

  .sidebar-count {
    font-size: 0.6rem;
    color: var(--sl-color-gray-3);
    margin-top: 0.15rem;
    height: 0.7rem;
    text-align: right;
  }

  .kbd-hint {
    position: absolute;
    right: 0.4rem;
    pointer-events: none;
    opacity: 0.5;
    display: flex;
    align-items: center;
  }

  /* hide hint when typing or focused */
  .sidebar-search-wrapper:focus-within .kbd-hint {
    display: none;
  }

  /* hide items that don't match */
  :global(.sidebar-content [data-hidden="true"]) {
    display: none !important;
  }

  /* snap sidebar content to the filter bar */
  :global(.sidebar-content > ul) {
    margin-top: 0 !important;
  }

  /*
  // status light badge transformation
  // converts starlight badges into small colored dots
  */
  :global(.sidebar-content .sl-badge) {
    display: inline-block !important;
    padding: 0 !important;
    min-width: 7px !important;
    width: 7px !important;
    height: 7px !important;
    border-radius: 50% !important;
    border: none !important;
    margin-left: 0.5rem !important;
    font-size: 0 !important;
    line-height: 0 !important;
    vertical-align: middle;
    margin-top: -2px;
  }

  /* color mappings */
  :global(.sidebar-content .sl-badge.caution) {
    background-color: var(--sl-color-orange) !important;
  }
  :global(.sidebar-content .sl-badge.danger) {
    background-color: var(--sl-color-red) !important;
  }
  :global(.sidebar-content .sl-badge.success) {
    background-color: var(--sl-color-green) !important;
  }
  :global(.sidebar-content .sl-badge.tip) {
    background-color: var(--sl-color-blue) !important;
  }
  :global(.sidebar-content .sl-badge.note) {
    background-color: var(--sl-color-purple) !important;
  }
</style>

<script>
  function init() {
    const input = document.getElementById("sidebar-input") as HTMLInputElement;
    const countDisplay = document.getElementById("sidebar-count");
    if (!input) return;

    //
    // cache sidebar structure
    const sidebarLinks = Array.from(
      document.querySelectorAll(".sidebar-content a"),
    ).map((link) => ({
      el: link,
      listItem: link.closest("li"),
      normalized: link.textContent?.toLowerCase().replace(/[\s\._]/g, "") || "",
    }));

    const groups = Array.from(
      document.querySelectorAll(".sidebar-content details"),
    );
    const initialGroupStates = new Map(
      groups.map((g) => [g, (g as HTMLDetailsElement).open]),
    );

    //
    // convert badge text to native tooltips
    document.querySelectorAll(".sidebar-content .sl-badge").forEach((badge) => {
      const text = badge.textContent;
      if (text) badge.setAttribute("title", text);
    });

    //
    // core filter logic
    input.addEventListener("input", () => {
      const term = input.value.toLowerCase().replace(/[\s\._]/g, "");
      let matchCount = 0;

      if (term === "") {
        sidebarLinks.forEach((item) =>
          item.listItem?.setAttribute("data-hidden", "false"),
        );
        groups.forEach((group) => {
          (group as HTMLDetailsElement).open =
            initialGroupStates.get(group) || false;
          group.setAttribute("data-hidden", "false");
        });
        if (countDisplay) countDisplay.textContent = "";
        return;
      }

      sidebarLinks.forEach((item) => {
        const isMatch = item.normalized.includes(term);
        if (isMatch) {
          matchCount++;
          item.listItem?.setAttribute("data-hidden", "false");

          // auto-expand parents
          let parent = item.listItem?.parentElement;
          while (parent && !parent.classList.contains("sidebar-content")) {
            if (parent.tagName === "DETAILS")
              (parent as HTMLDetailsElement).open = true;
            parent = parent.parentElement;
          }
        } else {
          item.listItem?.setAttribute("data-hidden", "true");
        }
      });

      // hide empty headers
      groups.forEach((group) => {
        const visible = group.querySelectorAll('li[data-hidden="false"]');
        group.setAttribute(
          "data-hidden",
          visible.length === 0 ? "true" : "false",
        );
      });

      if (countDisplay) {
        countDisplay.textContent =
          matchCount > 0 ? `${matchCount} matches` : "No results";
      }
    });

    //
    // shortcuts: press '/' to focus, 'esc' to clear
    window.addEventListener("keydown", (e) => {
      if (e.key === "/" && document.activeElement?.tagName !== "INPUT") {
        e.preventDefault();
        input.focus();
        input.select();
      }
      if (e.key === "Escape" && document.activeElement === input) {
        input.value = "";
        input.dispatchEvent(new Event("input"));
        input.blur();
      }
    });
  }

  //
  // run on initial load and after starlight navigation
  init();
  document.addEventListener("astro:after-swap", init);
</script>
