---
import { getCollection } from "astro:content";

interface Props {
  id: string;
  label?: string;
}

const { id, label } = Astro.props;
const allDocs = await getCollection("docs");

// find the document matching the id or filename
const entry = allDocs.find((doc) => doc.id === id || doc.id === `${id}.mdx`);

const title = entry?.data.title;
const description = entry?.data.description;
const badge = entry?.data.sidebar?.badge;

// handle base url for github pages or nested paths
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");
const href = `${baseUrl}/${id}/`.replace(/\/+/g, "/");
---

{
  !entry ? (
    <span class="ref-error">
      {label || id}
      <span class="error-tooltip">reference not found</span>
    </span>
  ) : (
    <span class="ref-container">
      <a href={href} class="ref-link">
        {label || title}
      </a>
      <span class="preview-card" role="tooltip">
        <span class="card-header">
          <span class="card-title">{title}</span>
          {badge && <span class={`badge ${badge.variant}`}>{badge.text}</span>}
        </span>
        {description && <span class="card-body">{description}</span>}
      </span>
    </span>
  )
}

<style>
  /* container is inline to stay within text flow */
  .ref-container {
    position: relative;
    display: inline-block;
    vertical-align: baseline;
  }

  .ref-container:hover {
    z-index: 1000;
  }

  /* clean link with subtle persistent underline */
  .ref-link {
    color: var(--sl-color-accent-high);
    text-decoration: none;
    border-bottom: 1px solid
      color-mix(in srgb, var(--sl-color-accent-high), transparent 70%);
    transition: border-color 0.1s ease;
    /* prevents the anchor itself from wrapping to next line */
    white-space: nowrap;
  }

  .ref-link:hover {
    border-bottom-color: var(--sl-color-accent-high);
  }

  /* wikipedia-style article preview card */
  .preview-card {
    position: absolute;
    /* centered horizontally relative to the word */
    left: 50%;
    bottom: calc(100% + 12px);
    transform: translateX(-50%) translateY(4px);

    width: 280px;
    padding: 0.8rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;

    background-color: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 2px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);

    /* hidden by default */
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 0.15s ease,
      transform 0.15s ease;
    z-index: 10000000;

    /* card text formatting */
    white-space: normal;
    line-height: 1.4;
    text-align: left;
    text-decoration: none;
  }

  /* vertical anchor arrow */
  .preview-card::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: var(--sl-color-gray-5);
  }

  /* reveal on hover */
  .ref-container:hover .preview-card {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* card internal layout */
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.1rem;
  }

  .card-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--sl-color-white);
  }

  .card-body {
    font-size: 0.8rem;
    color: var(--sl-color-gray-3);
    /* clamps desc. to 3 lines */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* starlight badge overrides for lowercase style */
  .badge {
    font-size: 0.6rem;
    padding: 0px 5px;
    border-radius: 2px;
    text-transform: lowercase;
    font-weight: 600;
    background: var(--sl-color-gray-6);
    color: var(--sl-color-gray-2);
    border: 1px solid var(--sl-color-gray-5);
  }
  .badge.caution {
    color: var(--sl-color-orange);
    border-color: var(--sl-color-orange-low);
  }
  .badge.danger {
    color: var(--sl-color-red);
    border-color: var(--sl-color-red-low);
  }

  /* error handling for broken documentation links */
  .ref-error {
    color: var(--sl-color-red);
    text-decoration: underline wavy var(--sl-color-red-low);
    cursor: help;
    position: relative;
    display: inline-block;
  }

  .error-tooltip {
    visibility: hidden;
    position: absolute;
    bottom: 110%;
    left: 0;
    background: var(--sl-color-red);
    color: white;
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
    border-radius: 2px;
    white-space: nowrap;
  }

  .ref-error:hover .error-tooltip {
    visibility: visible;
  }
</style>
