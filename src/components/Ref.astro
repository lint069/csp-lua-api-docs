---
import { getEntry } from "astro:content";

const { id, label } = Astro.props;

const cleanId = id.replace(/^\/|\/$/g, "");
const entry =
  (await getEntry("docs", cleanId)) ||
  (await getEntry("docs", `${cleanId}.mdx`)) ||
  (await getEntry("docs", `${cleanId}.md`));

const base = import.meta.env.BASE_URL.replace(/\/$/, "");
const href = `${base}/${cleanId}/`.replace(/\/+/g, "/");

const badge = entry?.data?.sidebar?.badge;
const variant = badge?.variant || "default";
---

<span class="ref-container">
  {
    entry ? (
      <>
        <a href={href} class="ref-link">
          {label || entry.data.title}
        </a>
        <span
          class="ref-tooltip"
          role="tooltip"
          data-variant={variant}
          data-has-badge={!!badge}
        >
          {badge && <span class="ref-status-bar" />}
          <span class="tooltip-title">{entry.data.title}</span>
          <span class="tooltip-desc">{entry.data.description}</span>
        </span>
      </>
    ) : (
      <>
        <span class="ref-link ref-error-link">{label || id}</span>
        <span
          class="ref-tooltip"
          role="tooltip"
          data-variant="danger"
          data-has-badge="true"
        >
          <span class="ref-status-bar" />
          <span class="tooltip-title">Broken reference</span>
          <span class="tooltip-desc">
            No docs page exists for <code class="ref-code">{cleanId}</code>.
            Rename the reference or create{" "}
            <code class="ref-code">{cleanId}.mdx</code>.
          </span>
        </span>
      </>
    )
  }
</span>

<style>
  .ref-container {
    position: relative;
    display: inline-block;
    text-indent: 0;
  }

  .ref-link {
    /* style */
    color: var(--sl-color-accent-high);
    text-decoration: none;
    border-bottom: 1px solid
      color-mix(in srgb, var(--sl-color-accent-high), transparent 70%);
    white-space: nowrap;

    /* visual hover */
    padding: 0 2px;
    border-radius: 2px;
    transition:
      border-color 0.15s ease,
      background-color 0.15s ease;
  }

  .ref-link:hover {
    border-bottom-color: var(--sl-color-accent-high);
    background-color: color-mix(
      in srgb,
      var(--sl-color-accent-high),
      transparent 92%
    );
    cursor: pointer;
  }

  /* invalid link */
  .ref-error-link {
    color: var(--sl-color-red-high);
    border-bottom: 1px dashed var(--sl-color-red-high);
    font-family: var(--sl-font-mono);
    font-size: 0.9em;
  }

  .ref-tooltip {
    /* layout */
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%) translateY(4px);
    width: 240px;
    z-index: 1000;

    /* vis */
    padding: 0.8rem;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.4),
      0 4px 6px -2px rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    overflow: hidden;

    /* behaviour */
    visibility: hidden;
    opacity: 0;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
    pointer-events: none;

    /* style */
    font-size: var(--sl-text-xs);
    line-height: 1.5;
    white-space: normal;
    text-align: left;
  }

  /* offset content only if badge exists */
  .ref-tooltip[data-has-badge="true"] {
    padding-top: 1.1rem;
  }

  /* status + mappings */
  .ref-status-bar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background-color: var(--sl-color-gray-4);
  }
  .ref-tooltip[data-variant="caution"] .ref-status-bar {
    background-color: var(--sl-color-orange);
  }
  .ref-tooltip[data-variant="danger"] .ref-status-bar {
    background-color: var(--sl-color-red);
  }
  .ref-tooltip[data-variant="success"] .ref-status-bar {
    background-color: var(--sl-color-green);
  }
  .ref-tooltip[data-variant="tip"] .ref-status-bar {
    background-color: var(--sl-color-blue);
  }
  .ref-tooltip[data-variant="note"] .ref-status-bar {
    background-color: var(--sl-color-purple);
  }

  .ref-container:hover .ref-tooltip {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .tooltip-title {
    display: block;
    font-weight: 700;
    color: var(--sl-color-white);
    margin-bottom: 0.25rem;
  }

  .tooltip-desc {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    color: var(--sl-color-gray-3);
  }

  .ref-code {
    color: var(--sl-color-red-high);
    font-family: var(--sl-font-mono);
  }
</style>
